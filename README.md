## Filament Evaluation

Evaluation artifact for [Filament HDL][filament] presented in the paper ["Modular Hardware Design with Timeline Types"][fil-paper].

## Kick-the-Tires Phase (2-4 hours)

For the kick-the-tires phase we will:
- Install the Filament compiler toolchain
- Install external dependencies that cannot be packaged due to licensing requirements

The second step requires the reviewer to [create a Xilinx account][xilinx-account] in order to download Xilinx's hardware synthesis tools.

### Using the VM

The artifact is available in two formats: A virtual machine image and through code repositories hosted on Github.

**Using the VM**.
The VM is packaged as an OVA file and can be downloaded from a permanent link [here][vm-link].
Our instructions assume you're using [VirtualBox][].

**Login Information**: The username and password are `filament`.

- Minimum host disk space required to install external tools: 65 GB
- Increase number of cores and RAM
  - Select the VM and click "Settings".
  - Select "System" > "Motherboard" and increase the "Base Memory" to 8 GB.
  - Select "System" > "Processor" and select at least 4 cores.

**SSH Configuration**: We've configured the VM to accept SSH connections at port 3022. If you prefer using a command line, connect to the VM by running the following command after starting it up:
```
ssh -p 3022
```

<details>
<summary><b>Troubleshooting common VM problems</b> [click to expand]</summary>

 - **Running out of disk space while installing Vivado tools**. The Vivado installer will sometimes
 crash or not start if there is not enough disk space. The Virtual Machine is configured to use
 a dynamically sized disk, so to solve this problem, simply clear space on the host machine. You need about 65 gbs of free space.
 - **Running out of memory**. Vivado, Vivado HLS, and Verilator all use a fair amount of memory. If there
 is not enough memory available to the VM, they will crash and data won't be generated. If something fails you can do one of:
   - Increase the RAM and rerun the script that had a failure.
   - Ignore the failure, the figure generation scripts are made to be resilient to this kind of data failure.
</details>

### Installing from Source

If you're using the VM, skip to the next section.

**TK**

### Sanity Check: Filament Installation

At this point, you should have the Filament compiler fully set up. To make sure everything is working, run Filament's test suite by typing the following command in the Filament repository:
```
runt -j 1
```
This should not report any errors.

### Installing External Tools (Estimated time: 2-4 hours)
Our evaluation uses Xilinx's Vivado and Vivado HLS tools to generate area and resource estimates.
Unfortunately due to licensing restrictions, we can't distribute the VM with these tools installed.
However, the tools are freely available and below are instructions on how to install them.

Our evaluation requires **Vivado WebPACK v.2020.2**.
Due to the [instability of synthesis tools][verismith], we cannot guarantee our evaluation works with a newer or older version of the Vivado tools.

If you're installing the tools on your own machine instead the VM, you can [download the installer][vivado-webpack].
The following instructions assume you're using the VM:

- Log in to the VM with the username `filament` and the password `filament`.
- The desktop should have a file named: `Xilinx Installer`. Double click on this to launch the installer.
- Ignore the warning and press `Ok`.
- When the box pops up asking you for a new version, click `Continue`.
- Enter your Xilinx credentials. If you don't have them, [create a Xilinx account][xilinx-account].
  - **Note** When you create an account, you need to fill out all the required information on [your profile][xilinx-profile].
  Otherwise [the Xilinx installer will reject your login](xilinx-fill-account).
  - The "User ID" is the email address of the Xilinx account you created.
- Agree to the contract and press `Next`.
- Choose `Vivado` and click `Next`.
- Choose `Vivado HL WebPACK` and click `Next`.
- Leave the defaults for selecting devices and click `Next`.
- **Important!** Change the install path from `/tools/Xilinx` to `/home/filament/Xilinx`.
- Confirm that you want to create the directory.
- Click Install. Depending on the speed of your connection, the whole process should take about 2 - 4 hrs.

### Sanity Check: External Tools

We've provided a script that synthesizes a Filament design and reports the final numbers: **TK**

## Step-by-step Instructions

The artifact reproduces the following claims:
1. Latency information generated by Aetherling (Table 1)
2. Incorrect interface for Aetherling modules (Section 7.1, Figure after "Underutilized Designs" paragraph)
3. Resource number for Filament and Aetherling designs

The evaluation uses hardware designs generated by [Aetherling][] and [Reticle][]. The artifact already contains the Verilog generated by the tools.
While we provide instructions to regenerate the Verilog files from those tools, we do not make claims about the continued functionality of those tools.

### Table 1: Aetherling Latencies

Table 1 compares the latencies reported by the Aetherling compiler with the latency that works with Filament's timing-accurate test harness.
The `aetherling/` folder contains Verilog files generated by the [Aetherling artifact][aeth-artifact].
Our artifact provides a CSV that contains the latencies reported by the Aetherling compiler (**TK**).
While we provide instructions to regenerate this data, we consider this out-of-scope of for this artifact's evaluation.

<details>
<summary><b>Regenerating Aetherling Latency Data</b> [click to expand]</summary>

Generating latency information requires the [Aetherling artifact][aeth-artifact]. Our provided instructions work when using the [Aetherling artifact VM][aeth-artifact-vm]:

- Download and configure the Aetherling VM
- **TK**
- In the command line REPL, run:
```
map compute_latency conv_2d_ppar
map compute_latency sharpen_ppar
```
- The above commands will cause the run the Aetherling compiler on all the `conv_2d` and `sharpen` designs and report the results in the form of a 7-element array which tracks the latencies for designs with the following throughputs: `[16, 8, 4, 2, 1, 1/3, 1/9]`.

</details>

**TLDR**: Run the following command and note that 4 designs generate incorrect outputs:
```
runt -j 1 -i table-1/
```

The expected output looks like:
```
✗ aetherling latencies:table-1/aetherling/conv2d_48.fil
✗ aetherling latencies:table-1/aetherling/conv2d_144.fil
✗ aetherling latencies:table-1/aetherling/sharpen48.fil
✗ aetherling latencies:table-1/aetherling/sharpen144.fil
```

**Explanation.** Our evaluation demonstrates that running Aetherling designs with latency reported by the compiler generates incorrect results.
We do this by providing two harnesses: one that runs the design the Aetherling latency and another one that runs it with Filament's latency that we found through trial and error.
The `table-1` folder contains the experiment data in the following folders:
1. `verilog`: Aetherling generated Verilog modules
2. `data`: Aetherling test harness data for each module
3. `golden`: Expected "golden" output for each test validated using the Aetherling test harness.
4. `filament`: Harnesses to run modules with Filament latencies
5. `aetherling`: Harnesses to run modules with Aetherling latencies.

The above command runs each module with the corresponding data and the filament and Aetherling harnesses and compares the generated output with the golden output.

*Optional*: To investigate how the inputs differ from expected ones, run the following command.
```
runt -j 1 -d -i table-1/
```

> **NOTE**: Table 1 reports that there are *5* incorrect designs, but we discovered that `conv2d_1` works correctly and therefore only *4* designs have incorrect latencies. We've updated the paper to reflect this and informed our reviewers.

Run the following command to get a CSV with all the latencies:
```
/scripts/extract-latencies.py table-1/**/*.fil
```

The generated CSV file corresponds to table 1.

### Mismatched Interface

Section 7.1, Paragraph "Underutilized designs" claims that Aetherling-generated designs violate the interface implied by Aetherling's type system.
We use a test harness similar to one from the previous section to demonstrate that the expected interface is incorrect.

**TLDR**: Run the following command and to note that using Aetherling's interface generated the wrong output:
```
runt -i mismatched-interface -j 1
```

### Table 2: Quantitative Comparison

Table 2 reports the resource usage of designs generated by Filament to ones generated by Aetherling and Reticle. This evaluation **requires** Vivado synthesis toolchains to be installed.